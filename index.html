<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Магазин доставки еды</title>

  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    let cart = [];
    let categories = {};
    const tg = window.Telegram.WebApp;
    tg.expand(); // Разворачиваем Mini App на весь экран

    // Функции для сохранения и загрузки данных корзины
    function saveCart() {
      localStorage.setItem("cartData", JSON.stringify(cart));
    }

    function loadCart() {
      const storedCart = localStorage.getItem("cartData");
      if (storedCart) {
        cart = JSON.parse(storedCart);
        updateCartButton();
      }
    }

    // Функции для сохранения и загрузки данных формы заказа (без новых полей, они обрабатываются при отправке)
    function saveOrderFormData() {
      const orderData = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        street: document.getElementById("street").value,
        house: document.getElementById("house").value,
        entrance: document.getElementById("entrance").value,
        floor: document.getElementById("floor").value,
        apartment: document.getElementById("apartment").value,
        intercom: document.getElementById("intercom").value,
        deliveryType: document.getElementById("delivery_type").value,
        orderDescription: document.getElementById("order_description").value,
        numPersons: document.getElementById("num_persons").value,
        deliveryTime: document.getElementById("delivery_time").value,
        paymentType: document.getElementById("payment_type").value
      };
      localStorage.setItem("orderFormData", JSON.stringify(orderData));
    }

    function loadOrderFormData() {
      const savedData = localStorage.getItem("orderFormData");
      if (savedData) {
        const orderData = JSON.parse(savedData);
        document.getElementById("name").value = orderData.name || "";
        document.getElementById("phone").value = orderData.phone || "";
        document.getElementById("street").value = orderData.street || "";
        document.getElementById("house").value = orderData.house || "";
        document.getElementById("entrance").value = orderData.entrance || "";
        document.getElementById("floor").value = orderData.floor || "";
        document.getElementById("apartment").value = orderData.apartment || "";
        document.getElementById("intercom").value = orderData.intercom || "";
        document.getElementById("delivery_type").value = orderData.deliveryType || "delivery";
        document.getElementById("order_description").value = orderData.orderDescription || "";
        document.getElementById("num_persons").value = orderData.numPersons || "1";
        document.getElementById("delivery_time").value = orderData.deliveryTime || "";
        document.getElementById("payment_type").value = orderData.paymentType || "card";
      }
    }

    // Если в URL есть параметр order_data, загружаем его и сохраняем в localStorage и в форму

  // Если в URL есть параметр order_data, загружаем его и сохраняем в localStorage и в форму
  function loadOrderDataFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const orderDataParam = urlParams.get('order_data');
    if (orderDataParam) {
      try {
        const orderDataStr = atob(orderDataParam);
        const orderData = JSON.parse(orderDataStr);
        // Заполняем поля формы из orderData.delivery_info
        if (orderData.delivery_info) {
          document.getElementById("name").value = orderData.delivery_info.name || "";
          document.getElementById("phone").value = orderData.delivery_info.phone || "";
          document.getElementById("street").value = orderData.delivery_info.street || "";
          document.getElementById("house").value = orderData.delivery_info.house || "";
          document.getElementById("entrance").value = orderData.delivery_info.entrance || "";
          document.getElementById("floor").value = orderData.delivery_info.floor || "";
          document.getElementById("apartment").value = orderData.delivery_info.apartment || "";
          document.getElementById("intercom").value = orderData.delivery_info.intercom || "";
          document.getElementById("delivery_type").value = orderData.delivery_info.deliveryType || "delivery";
          document.getElementById("order_description").value = orderData.delivery_info.orderDescription || "";
          document.getElementById("num_persons").value = orderData.delivery_info.numPersons || "1";
          document.getElementById("delivery_time").value = orderData.delivery_info.deliveryTime || "";
          document.getElementById("payment_type").value = orderData.delivery_info.paymentType || "card";
        }
        // Если в orderData есть товары, сохраняем их в корзину и обновляем отображение
        if (orderData.items) {
          cart = orderData.items;
          updateCartButton();
          renderCartItems();
          saveCart();
        }
        // Сохраняем данные формы в localStorage, чтобы они не пропали
        saveOrderFormData();
        console.log("Данные из URL успешно загружены");
        // После загрузки удаляем параметры из URL, чтобы дальнейшие изменения не перезаписывались
        history.replaceState(null, "", window.location.pathname);
      } catch (e) {
        console.error("Ошибка загрузки данных из URL: ", e);
      }
    }
  }

  // Остальной код остается без изменений...
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Загрузка меню...");
    fetchMenu();
    loadCart();
    // Если URL содержит параметр order_data, загружаем данные для редактирования
    loadOrderDataFromURL();
    // Если нет, пробуем загрузить сохранённые данные из localStorage
    loadOrderFormData();
  });



    // Получение меню с сервера
    async function fetchMenu() {
      try {
        const response = await fetch("http://127.0.0.1:8000/menu");
        const data = await response.json();
        console.log("Данные меню:", data);
        if (typeof data === "object" && !Array.isArray(data)) {
          processMenuData(data);
        } else {
          console.error("Ошибка: полученные данные не являются объектом с категориями", data);
        }
      } catch (error) {
        console.error("Ошибка загрузки меню:", error);
      }
    }

    function processMenuData(data) {
      categories = {};
      for (let categoryId in data) {
        const category = data[categoryId];
        categories[categoryId] = {
          name: category.name,
          items: category.items || []
        };
      }
      renderCategories();
    }

    function renderCategories() {
      const categoriesContainer = document.querySelector(".categories");
      if (!categoriesContainer) {
        console.error("Элемент .categories не найден в DOM");
        return;
      }
      categoriesContainer.innerHTML = "";
      for (let categoryId in categories) {
        const category = categories[categoryId];
        const categoryButton = document.createElement("button");
        categoryButton.innerText = category.name;
        categoryButton.onclick = () => showItems(categoryId);
        categoriesContainer.appendChild(categoryButton);
      }
    }

    function showItems(categoryId) {
      const itemsContainer = document.getElementById("items");
      if (!itemsContainer) {
        console.error("Элемент #items не найден в DOM");
        return;
      }
      itemsContainer.innerHTML = "";
      const category = categories[categoryId];
      if (!category || !category.items) {
        console.error("Категория или товары не найдены");
        return;
      }
      category.items.forEach((item) => {
        const itemCard = document.createElement("div");
        itemCard.className = "item-card";
        // Если поле externalId существует, используем его, иначе обычный id
        const externalId = item.externalId ? item.externalId : item.id;
        itemCard.innerHTML = `
          <img src="${item.image}" alt="${item.name}" onclick="showItemDetails('${categoryId}', '${item.name}')">
          <h3>${item.name}</h3>
          <p>${item.price}₽</p>
          <button class="add-to-cart" onclick="addToCart('${externalId}', '${item.name}', ${item.price})">Добавить</button>
        `;
        itemsContainer.appendChild(itemCard);
      });
    }

    // Функция addToCart сохраняет externalId товара
    function addToCart(itemExternalId, itemName, itemPrice) {
      let cartItem = cart.find((i) => i.externalId === itemExternalId);
      if (cartItem) {
        cartItem.quantity++;
      } else {
        cart.push({ externalId: itemExternalId, name: itemName, price: itemPrice, quantity: 1 });
      }
      updateCartButton();
      // Сохраняем корзину сразу, чтобы данные были актуальны до подтверждения заказа
      saveCart();
    }

    function updateCartButton() {
      const cartBtn = document.getElementById("cart-button");
      if (cartBtn) {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartBtn.innerText = `🛒 Корзина (${totalItems})`;
      }
    }

    function showCart() {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("cart-content").style.display = "block";
      renderCartItems();
    }

    function renderCartItems() {
      const cartItemsContainer = document.getElementById("cart-items");
      if (cartItemsContainer) {
        cartItemsContainer.innerHTML = "";
        if (cart.length === 0) {
          cartItemsContainer.innerHTML = "<p>Корзина пуста</p>";
        } else {
          let total = 0;
          cart.forEach((item) => {
            total += item.price * item.quantity;
            const cartItem = document.createElement("div");
            cartItem.className = "cart-item";
            cartItem.innerHTML = `
              <p>${item.name} - ${item.price}₽ x ${item.quantity}</p>
              <button onclick="removeFromCart('${item.externalId}')">❌</button>
            `;
            cartItemsContainer.appendChild(cartItem);
          });
          // Выводим итоговую сумму
          const totalDiv = document.createElement("div");
          totalDiv.className = "cart-total";
          totalDiv.innerHTML = `<p>Итоговая сумма: <strong>${total}₽</strong></p>`;
          cartItemsContainer.appendChild(totalDiv);
        }
      }
    }

    function removeFromCart(itemExternalId) {
      cart = cart.filter((i) => i.externalId !== itemExternalId);
      updateCartButton();
      saveCart();
      renderCartItems();
    }

    function showOrderForm() {
      document.getElementById("cart-content").style.display = "none";
      document.getElementById("order-form").style.display = "block";
      loadOrderFormData();
    }

    // При нажатии кнопки "Подтвердить заказ" сохраняем данные, отправляем их и очищаем localStorage.
    function submitOrder() {
      // Сохраняем данные формы и корзины непосредственно перед отправкой
      saveOrderFormData();
      saveCart();

      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;
      const street = document.getElementById("street").value;
      const house = document.getElementById("house").value;
      const entrance = document.getElementById("entrance").value;
      const floor = document.getElementById("floor").value;
      const apartment = document.getElementById("apartment").value;
      const intercom = document.getElementById("intercom").value;

      // Новые поля
      const deliveryType = document.getElementById("delivery_type").value;
      const orderDescription = document.getElementById("order_description").value;
      const numPersons = document.getElementById("num_persons").value;
      const deliveryTime = document.getElementById("delivery_time").value;
      const paymentType = document.getElementById("payment_type").value;

      if (!name || !phone || !street || !house || !entrance || !floor || !apartment || !intercom ||
          !deliveryType || !numPersons || !deliveryTime || !paymentType) {
        alert("Пожалуйста, заполните все обязательные поля!");
        return;
      }

      const order = {
        user_id: tg.initDataUnsafe.user?.id || "unknown",
        // Передаём товары с externalId
        items: cart.map((item) => ({ externalId: item.externalId, price: item.price, quantity: item.quantity })),
        delivery_info: {
          name,
          phone,
          street,
          house,
          entrance,
          floor,
          apartment,
          intercom,
          deliveryType,       // Доставка или самовывоз
          orderDescription,   // Дополнительное описание заказа
          numPersons,         // Количество человек
          deliveryTime,       // Время доставки
          paymentType         // Способ оплаты
        }
      };

      // Отправляем данные заказа боту
      tg.sendData(JSON.stringify(order));
      
      // После отправки очищаем сохранённые данные
      localStorage.removeItem("cartData");
      localStorage.removeItem("orderFormData");
      
      tg.close();
    }

    function backToCart() {
      document.getElementById("order-form").style.display = "none";
      document.getElementById("cart-content").style.display = "block";
    }

    function showItemDetails(categoryId, itemName) {
      alert(`Детали товара: ${itemName}`);
    }

    document.addEventListener("DOMContentLoaded", function () {
      console.log("Загрузка меню...");
      fetchMenu();
      loadCart();
      // Если URL содержит параметр order_data, загружаем данные для редактирования
      loadOrderDataFromURL();
      // Если нет, пробуем загрузить сохранённые данные из localStorage
      loadOrderFormData();
    });
  </script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto p-4">
      <h1 class="text-3xl font-bold text-center mb-6">🍔 Магазин доставки еды</h1>
      
      <div class="categories flex justify-center space-x-4 mb-6"></div>
      
      <div id="items" class="grid grid-cols-2 gap-4"></div>
      
      <button id="cart-button" class="fixed bottom-4 right-4 bg-blue-500 text-white px-6 py-2 rounded-lg shadow-lg">
        🛒 Корзина (0)
      </button>
    </div>
  
    <div id="cart-content" class="hidden container mx-auto p-4 bg-white shadow-lg rounded-lg">
      <h2 class="text-2xl font-semibold mb-4">Корзина</h2>
      <div id="cart-items" class="space-y-2"></div>
      <button class="w-full bg-green-500 text-white py-2 mt-4 rounded" onclick="showOrderForm()">✅ Оформить заказ</button>
      <button class="w-full bg-gray-300 py-2 mt-2 rounded" onclick="toggleCart(false)">Вернуться к меню</button>
    </div>
  
    <div id="order-form" class="hidden container mx-auto p-4 bg-white shadow-lg rounded-lg">
      <h2 class="text-2xl font-semibold mb-4">Оформление заказа</h2>
      <form onsubmit="event.preventDefault(); submitOrder();" class="space-y-3">
        <input type="text" id="name" placeholder="Имя" class="w-full p-2 border rounded" required>
        <input type="tel" id="phone" placeholder="Номер телефона" class="w-full p-2 border rounded" required>
        <input type="text" id="street" placeholder="Улица" class="w-full p-2 border rounded" required>
        <input type="text" id="house" placeholder="Дом" class="w-full p-2 border rounded" required>
        <input type="text" id="apartment" placeholder="Квартира" class="w-full p-2 border rounded" required>
        <select id="payment_type" class="w-full p-2 border rounded" required>
          <option value="card">Картой</option>
          <option value="cash">Наличными</option>
        </select>
        <button type="submit" class="w-full bg-green-500 text-white py-2 rounded">Подтвердить заказ</button>
        <button type="button" class="w-full bg-gray-300 py-2 rounded" onclick="toggleCart(true)">Вернуться</button>
      </form>
    </div>
  
    <script>
      function toggleCart(show) {
        document.getElementById('main-content').classList.toggle('hidden', show);
        document.getElementById('cart-content').classList.toggle('hidden', !show);
      }
      
      function showOrderForm() {
        document.getElementById('cart-content').classList.add('hidden');
        document.getElementById('order-form').classList.remove('hidden');
      }
  
      function submitOrder() {
        alert('Заказ отправлен!');
      }
    </script>
  </body>
  </html>

