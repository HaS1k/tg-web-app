<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ö–æ—Ñ–µ–π–Ω—è THE CUP</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 0;
    }

    .coffee-bg {
      background: #f2e9e4;
    }

    .container {
      max-width: 400px;
      margin: auto;
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .coffee-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #4a2f23;
    }

    .coffee-btn {
      background: #4a2f23;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      font-weight: 500;
    }
    .coffee-btn:hover {
      background: #3b231a;
    }

    .product-card {
      border: 1px solid #e0d4ce;
      border-radius: 8px;
      background: #fff5f0;
      transition: transform 0.2s;
    }
    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .product-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }

    .cart-item {
      background: #fffaf6;
      border: 1px solid #e0d4ce;
      border-radius: 5px;
      padding: 8px;
      margin-bottom: 8px;
    }

    .cart-item .btn {
      padding: 2px 6px;
      font-size: 0.9rem;
    }

    .cart-total {
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 10px;
    }

    .form-section {
      background: #fffaf6;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
    }

    .form-section label {
      font-weight: 500;
    }

    .d-none {
      display: none !important;
    }
  </style>
</head>
<body class="coffee-bg">
  <div class="container py-3">
    <header class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="coffee-title">‚òï THE CUP</h1>
      <button id="cart-button" class="btn coffee-btn">
        üõí <span id="cart-count">0</span>
      </button>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
    <div id="main-content">
      <div id="categories" class="mb-3"></div>
      <div id="items" class="row g-3"></div>
    </div>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <div id="cart-content" class="d-none">
      <button class="btn coffee-btn mb-3" onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
      <div id="cart-items"></div>
      <button class="btn coffee-btn mt-3" onclick="showOrderForm()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
    <div id="order-form" class="d-none">
      <button class="btn coffee-btn mb-3" onclick="backToCart()">‚Üê –ù–∞–∑–∞–¥</button>
      <form onsubmit="submitOrder(); return false;">
        <div class="form-section mb-3">
          <label for="input-name" class="form-label">–§–ò–û</label>
          <input type="text" id="input-name" class="form-control" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required />
        </div>

        <div class="form-section mb-3">
          <label for="input-phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" id="input-phone" class="form-control" placeholder="+7 (___) ___-__-__" required />
        </div>

        <div class="form-section mb-3">
          <label for="input-street" class="form-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <div class="row g-2">
            <div class="col-8">
              <input type="text" id="input-street" class="form-control" placeholder="–£–ª–∏—Ü–∞" required />
            </div>
            <div class="col-4">
              <input type="text" id="input-house" class="form-control" placeholder="–î–æ–º" required />
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-3">
              <input type="text" id="input-entrance" class="form-control" placeholder="–ü–æ–¥—ä–µ–∑–¥" />
            </div>
            <div class="col-3">
              <input type="text" id="input-floor" class="form-control" placeholder="–≠—Ç–∞–∂" />
            </div>
            <div class="col-3">
              <input type="text" id="input-apartment" class="form-control" placeholder="–ö–≤–∞—Ä—Ç–∏—Ä–∞" />
            </div>
            <div class="col-3">
              <input type="text" id="input-intercom" class="form-control" placeholder="–î–æ–º–æ—Ñ–æ–Ω" />
            </div>
          </div>
        </div>

        <div class="form-section mb-3">
          <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω</label>
          <input type="number" id="input-persons" class="form-control" min="1" value="1" required />
        </div>

        <div class="form-section mb-3">
          <label for="input-time" class="form-label">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <input type="time" id="input-time" class="form-control" required />
        </div>

        <div class="form-section mb-3">
          <label class="form-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="payment" id="pay-card" value="card" checked />
            <label class="form-check-label" for="pay-card">–ö–∞—Ä—Ç–∞</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="payment" id="pay-cash" value="cash" />
            <label class="form-check-label" for="pay-cash">–ù–∞–ª–∏—á–Ω—ã–µ</label>
          </div>
          <div id="change-container" class="mt-2" style="display: none;">
            <input type="text" id="input-change" class="form-control" placeholder="–°–¥–∞—á–∞ —Å" />
          </div>
        </div>

        <div class="form-section mb-3">
          <label for="textarea-comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
          <textarea id="textarea-comment" class="form-control" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ..."></textarea>
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn coffee-btn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </form>
    </div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="product-modal-container"></div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.expand();

    // API_BASE URL
    const API_BASE = "http://127.0.0.1:8000";

    let cart = [];
    let categories = {};
    let currentItem = null;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω –º–æ–¥–∞–ª–∫–∏
    fetch('components/product-modal.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('product-modal-container').innerHTML = html;
        initModalLogic();
      });

    // –ü—Ä–∏ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    document.addEventListener('DOMContentLoaded', () => {
      // 1) –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
      cart = JSON.parse(localStorage.getItem('cartData') || '[]');
      updateCartCount();

      // 2) –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ—Ä–∑–∏–Ω—ã
      const cartBtn = document.getElementById('cart-button');
      if (cartBtn) cartBtn.addEventListener('click', showCart);

      // 3) –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—è ¬´–°–¥–∞—á–∞ —Å¬ª
      document.getElementById('pay-cash').addEventListener('change', toggleChange);
      document.getElementById('pay-card').addEventListener('change', toggleChange);

      // 4) –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é: —Å–Ω–∞—á–∞–ª–∞ –∏–∑ URL, –∏–Ω–∞—á–µ ‚Äì –ø–æ fetch
      const params = new URLSearchParams(window.location.search);
      if (params.has('menu_data')) {
        try {
          categories = JSON.parse(atob(params.get('menu_data')));
          processMenuData(categories);
        } catch (e) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å menu_data:', e);
          fetchMenu();
        }
      } else {
        fetchMenu();
      }
    });

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è ¬´–°–¥–∞—á–∞ —Å¬ª
    function toggleChange() {
      document.getElementById('change-container').style.display =
        document.getElementById('pay-cash').checked ? 'block' : 'none';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é —Å –±—ç–∫–µ–Ω–¥–∞
    async function fetchMenu() {
      try {
        console.log('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é...');
        const resp = await fetch(`${API_BASE}/menu`, { mode: 'cors' });
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', resp.status);
        if (!resp.ok) throw new Error(`–û—à–∏–±–∫–∞ ${resp.status}`);
        const data = await resp.json();
        processMenuData(data);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ fetchMenu:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é —Å —Å–µ—Ä–≤–µ—Ä–∞');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω—é
    function processMenuData(data) {
      categories = data;
      renderCategories();
      const first = Object.keys(categories)[0];
      if (first) showItems(first);
    }

    // –†–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function renderCategories() {
      const ctr = document.getElementById('categories');
      ctr.innerHTML = '';
      for (let cid in categories) {
        const btn = document.createElement('button');
        btn.className = 'btn coffee-btn me-2 mb-2';
        btn.innerText = categories[cid].name;
        btn.addEventListener('click', () => showItems(cid));
        ctr.appendChild(btn);
      }
    }

    // –ü–æ–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function showItems(cid) {
      const ctr = document.getElementById('items');
      ctr.innerHTML = '';
      categories[cid].items.forEach(item => {
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-md-4';
        col.innerHTML = `
          <div class="product-card">
            <img 
              src="${item.image || 'images/placeholder.png'}" 
              class="product-image" 
              alt="${item.name}"
              onerror="this.src='images/placeholder.png'"
            />
            <div class="p-2">
              <h6>${item.name}</h6>
              <p>${item.price} ‚ÇΩ</p>
              <button class="btn coffee-btn"
                      onclick="openModal('${cid}', '${item.externalId || item.id}')">
                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
              </button>
            </div>
          </div>
        `;
        ctr.appendChild(col);
      });
    }

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ —Ç–æ–≤–∞—Ä–∞
    function openModal(categoryId, extId) {
      const item = categories[categoryId].items
        .find(i => String(i.externalId || i.id) === extId);
      if (!item) return;
      currentItem = item;
      document.getElementById('modal-title').innerText = item.name;
      document.getElementById('modal-image').src = item.image || 'images/placeholder.png';
      document.getElementById('modal-desc').innerHTML = item.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
      renderModifiers(item.modifiers || []);
      new bootstrap.Modal('#productModal').show();
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤ –º–æ–¥–∞–ª–∫–µ
    function renderModifiers(mods) {
      const ctr = document.getElementById('modal-modifiers');
      ctr.innerHTML = '';
      mods.forEach(group => {
        const div = document.createElement('div');
        div.innerHTML = `<p class="mb-1"><strong>${group.name}</strong></p>`;
        group.options.forEach(opt => {
          const id = `mod-${group.id}-${opt.id}`;
          div.innerHTML += `
            <div class="form-check">
              <input class="form-check-input" 
                     type="${group.type === 'Single' ? 'radio' : 'checkbox'}" 
                     name="mod-${group.id}" 
                     id="${id}" 
                     value="${opt.id}">
              <label class="form-check-label" for="${id}">
                ${opt.name} (+${opt.cost}‚ÇΩ)
              </label>
            </div>
          `;
        });
        ctr.appendChild(div);
      });
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É¬ª –≤ –º–æ–¥–∞–ª–∫–µ
    function initModalLogic() {
      document.getElementById('modal-add-btn').onclick = () => {
        const selected = [];
        (currentItem.modifiers || []).forEach(group => {
          document.getElementsByName(`mod-${group.id}`).forEach(inp => {
            if (inp.checked) selected.push(inp.value);
          });
        });
        addToCart(currentItem, selected);
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
      };
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
    function addToCart(item, modifiers = []) {
      const key = (item.externalId || item.id) + modifiers.join(',');
      let ci = cart.find(i => i.key === key);
      if (ci) ci.quantity++;
      else cart.push({
        key,
        externalId: item.externalId || item.id,
        name: item.name,
        price: item.price,
        quantity: 1,
        modifiers
      });
      localStorage.setItem('cartData', JSON.stringify(cart));
      updateCartCount();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
    function updateCartCount() {
      const cnt = cart.reduce((sum, i) => sum + i.quantity, 0);
      document.getElementById('cart-count').innerText = cnt;
    }

    // –ü–æ–∫–∞–∑ –∏ —Å–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π
    function showCart() {
      document.getElementById('main-content').classList.add('d-none');
      document.getElementById('order-form').classList.add('d-none');
      document.getElementById('cart-content').classList.remove('d-none');
      renderCartItems();
    }
    function backToMain() {
      document.getElementById('cart-content').classList.add('d-none');
      document.getElementById('order-form').classList.add('d-none');
      document.getElementById('main-content').classList.remove('d-none');
    }
    function showOrderForm() {
      document.getElementById('cart-content').classList.add('d-none');
      document.getElementById('main-content').classList.add('d-none');
      document.getElementById('order-form').classList.remove('d-none');
    }
    function backToCart() {
      document.getElementById('order-form').classList.add('d-none');
      document.getElementById('cart-content').classList.remove('d-none');
    }

    // –†–∏—Å—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –º–µ–Ω—è—Ç—å –∫–æ–ª-–≤–æ/—É–¥–∞–ª—è—Ç—å
    function renderCartItems() {
      const ctr = document.getElementById('cart-items');
      ctr.innerHTML = '';
      if (cart.length === 0) {
        ctr.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
        return;
      }
      let total = 0;
      cart.forEach((item, idx) => {
        total += item.price * item.quantity;
        const div = document.createElement('div');
        div.className = 'cart-item d-flex justify-content-between align-items-center mb-2';
        div.innerHTML = `
          <span>${item.name}</span>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="decrementQuantity(${idx})">‚àí</button>
            <span>${item.quantity}</span>
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="incrementQuantity(${idx})">+</button>
            <span class="mx-3">${item.price * item.quantity}‚ÇΩ</span>
            <button class="btn btn-sm btn-danger" onclick="removeFromCart(${idx})">√ó</button>
          </div>
        `;
        ctr.appendChild(div);
      });
      ctr.insertAdjacentHTML('beforeend',
        `<div class="cart-total"><strong>–ò—Ç–æ–≥–æ: ${total}‚ÇΩ</strong></div>`
      );
    }

    function incrementQuantity(i) {
      cart[i].quantity++;
      saveCartState();
    }
    function decrementQuantity(i) {
      if (cart[i].quantity > 1) cart[i].quantity--;
      else cart.splice(i, 1);
      saveCartState();
    }
    function removeFromCart(i) {
      cart.splice(i, 1);
      saveCartState();
    }
    function saveCartState() {
      localStorage.setItem('cartData', JSON.stringify(cart));
      renderCartItems();
      updateCartCount();
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –±–æ—Ç—É
    function submitOrder() {
      // –°—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª—è
      const delivery_info = {
        name:         document.getElementById('input-name').value.trim(),
        phone:        document.getElementById('input-phone').value.trim(),
        street:       document.getElementById('input-street').value.trim(),
        house:        document.getElementById('input-house').value.trim(),
        entrance:     document.getElementById('input-entrance').value.trim(),
        floor:        document.getElementById('input-floor').value.trim(),
        apartment:    document.getElementById('input-apartment').value.trim(),
        intercom:     document.getElementById('input-intercom').value.trim(),
        numPersons:   document.getElementById('input-persons').value,
        deliveryTime: document.getElementById('input-time').value,
        paymentType:  document.querySelector('input[name="payment"]:checked').value,
        changeFrom:   document.getElementById('input-change').value.trim() || null,
        comment:      document.getElementById('textarea-comment').value.trim()
      };

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
      if (!delivery_info.name || !delivery_info.phone ||
          !delivery_info.street || !delivery_info.house ||
          !delivery_info.deliveryTime) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.');
        return;
      }
      if (cart.length === 0) {
        alert('–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.');
        return;
      }

      // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–∫–∞–∑
      const order = {
        items: cart.map(i => ({
          externalId: i.externalId,
          name:       i.name,
          price:      i.price,
          quantity:   i.quantity,
          modifiers:  i.modifiers
        })),
        delivery_info
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
      tg.sendData(JSON.stringify(order));

      // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      localStorage.removeItem('cartData');

      tg.close();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
