<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞–≥–∞–∑–∏–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã</title>
    <link rel="stylesheet" href="styles.css">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let cart = [];
        let categories = {};
        let tg = window.Telegram.WebApp;
        tg.expand();

        async function fetchMenu() {
            try {
                let response = await fetch('http://127.0.0.1:8000/menu');
                let data = await response.json();
                if (typeof data === 'object' && !Array.isArray(data)) {
                    processMenuData(data);
                } else {
                    console.error('–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏', data);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
            }
        }

        function processMenuData(data) {
            categories = {};
            for (let categoryId in data) {
                let category = data[categoryId];
                categories[categoryId] = {
                    name: category.name,
                    items: category.items || []
                };
            }
            renderCategories();
        }

        function renderCategories() {
            let categoriesContainer = document.querySelector(".categories");
            categoriesContainer.innerHTML = "";

            for (let categoryId in categories) {
                let category = categories[categoryId];
                let categoryButton = document.createElement("button");
                categoryButton.innerText = category.name;
                categoryButton.onclick = () => showItems(categoryId);
                categoriesContainer.appendChild(categoryButton);
            }
        }

        function showItems(categoryId) {
            let itemsContainer = document.getElementById("items");
            itemsContainer.innerHTML = "";

            let category = categories[categoryId];
            if (!category || !category.items) return;

            category.items.forEach(item => {
                let itemCard = document.createElement("div");
                itemCard.className = "item-card";
                itemCard.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <h3>${item.name}</h3>
                    <p>${item.price}‚ÇΩ</p>
                    <button onclick="addToCart('${categoryId}', '${item.name}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                `;
                itemsContainer.appendChild(itemCard);
            });
        }

        function addToCart(categoryId, itemName) {
            let category = categories[categoryId];
            if (!category) return;
            let item = category.items.find(i => i.name === itemName);
            if (!item) return;

            let cartItem = cart.find(i => i.name === itemName);
            if (cartItem) {
                cartItem.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            updateCartButton();
        }

        function updateCartButton() {
            let cartBtn = document.getElementById("cart-button");
            let totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartBtn.innerText = `üõí –ö–æ—Ä–∑–∏–Ω–∞ (${totalItems})`;
        }

        function showCart() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('cart-section').style.display = 'block';

            let cartContent = document.getElementById("cart-content");
            cartContent.innerHTML = cart.length === 0 ? "<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>" : "";
            cart.forEach(item => {
                let cartItem = document.createElement("div");
                cartItem.className = "cart-item";
                cartItem.innerHTML = `
                    <p>${item.name} - ${item.price}‚ÇΩ</p>
                    <input type="number" min="1" value="${item.quantity}" onchange="updateQuantity('${item.name}', this.value)">
                    <button onclick="removeFromCart('${item.name}')">‚ùå</button>
                `;
                cartContent.appendChild(cartItem);
            });
        }

        function updateQuantity(itemName, quantity) {
            let cartItem = cart.find(i => i.name === itemName);
            if (cartItem) {
                cartItem.quantity = parseInt(quantity, 10);
            }
        }

        function removeFromCart(itemName) {
            cart = cart.filter(i => i.name !== itemName);
            updateCartButton();
            showCart();
        }

        function showOrderForm() {
            document.getElementById('cart-section').style.display = 'none';
            document.getElementById('order-form').style.display = 'block';
        }

        function placeOrder() {
            if (cart.length === 0) {
                alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
                return;
            }

            let userName = document.getElementById("user-name").value;
            let userAddress = document.getElementById("user-address").value;
            let userPhone = document.getElementById("user-phone").value;

            if (!userName || !userAddress || !userPhone) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                return;
            }

            const order = {
                user_id: 12345,
                user_name: userName,
                address: userAddress,
                phone: userPhone,
                items: cart
            };

            Telegram.WebApp.sendData(JSON.stringify(order));
            Telegram.WebApp.close();
        }

        document.addEventListener("DOMContentLoaded", fetchMenu);
    </script>
</head>
<body>
    <div class="container">
        <h1>üçî –ú–∞–≥–∞–∑–∏–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã</h1>
        <div class="categories"></div>
        <div id="items" class="items"></div>
        <button id="cart-button" class="cart-button" onclick="showCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞ (0)</button>
    </div>

    <div id="cart-section" style="display: none;">
        <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div id="cart-content"></div>
        <button onclick="showOrderForm()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button onclick="document.getElementById('cart-section').style.display='none'; document.querySelector('.container').style.display='block'">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="order-form" style="display: none;">
        <h2>–§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞</h2>
        <input type="text" id="user-name" placeholder="–ò–º—è">
        <input type="text" id="user-address" placeholder="–ê–¥—Ä–µ—Å">
        <input type="text" id="user-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button onclick="placeOrder()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
</body>
</html>
