<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
  <script>
    let cart = [];
    let categories = {};
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º Mini App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω—ã
    function saveCart() {
      localStorage.setItem("cartData", JSON.stringify(cart));
    }

    function loadCart() {
      const storedCart = localStorage.getItem("cartData");
      if (storedCart) {
        cart = JSON.parse(storedCart);
        updateCartButton();
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞ (–±–µ–∑ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π, –æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ)
    function saveOrderFormData() {
      const orderData = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        street: document.getElementById("street").value,
        house: document.getElementById("house").value,
        entrance: document.getElementById("entrance").value,
        floor: document.getElementById("floor").value,
        apartment: document.getElementById("apartment").value,
        intercom: document.getElementById("intercom").value
      };
      localStorage.setItem("orderFormData", JSON.stringify(orderData));
    }

    function loadOrderFormData() {
      const savedData = localStorage.getItem("orderFormData");
      if (savedData) {
        const orderData = JSON.parse(savedData);
        document.getElementById("name").value = orderData.name || "";
        document.getElementById("phone").value = orderData.phone || "";
        document.getElementById("street").value = orderData.street || "";
        document.getElementById("house").value = orderData.house || "";
        document.getElementById("entrance").value = orderData.entrance || "";
        document.getElementById("floor").value = orderData.floor || "";
        document.getElementById("apartment").value = orderData.apartment || "";
        document.getElementById("intercom").value = orderData.intercom || "";
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–Ω—é —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function fetchMenu() {
      try {
        const response = await fetch("http://127.0.0.1:8000/menu");
        const data = await response.json();
        console.log("–î–∞–Ω–Ω—ã–µ –º–µ–Ω—é:", data);
        if (typeof data === "object" && !Array.isArray(data)) {
          processMenuData(data);
        } else {
          console.error("–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏", data);
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", error);
      }
    }

    function processMenuData(data) {
      categories = {};
      for (let categoryId in data) {
        const category = data[categoryId];
        categories[categoryId] = {
          name: category.name,
          items: category.items || []
        };
      }
      renderCategories();
    }

    function renderCategories() {
      const categoriesContainer = document.querySelector(".categories");
      if (!categoriesContainer) {
        console.error("–≠–ª–µ–º–µ–Ω—Ç .categories –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
        return;
      }
      categoriesContainer.innerHTML = "";
      for (let categoryId in categories) {
        const category = categories[categoryId];
        const categoryButton = document.createElement("button");
        categoryButton.innerText = category.name;
        categoryButton.onclick = () => showItems(categoryId);
        categoriesContainer.appendChild(categoryButton);
      }
    }

    function showItems(categoryId) {
      const itemsContainer = document.getElementById("items");
      if (!itemsContainer) {
        console.error("–≠–ª–µ–º–µ–Ω—Ç #items –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
        return;
      }
      itemsContainer.innerHTML = "";
      const category = categories[categoryId];
      if (!category || !category.items) {
        console.error("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
        return;
      }
      category.items.forEach((item) => {
        const itemCard = document.createElement("div");
        itemCard.className = "item-card";
        // –ï—Å–ª–∏ –ø–æ–ª–µ externalId —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π id
        const externalId = item.externalId ? item.externalId : item.id;
        itemCard.innerHTML = `
          <img src="${item.image}" alt="${item.name}" onclick="showItemDetails('${categoryId}', '${item.name}')">
          <h3>${item.name}</h3>
          <p>${item.price}‚ÇΩ</p>
          <button class="add-to-cart" onclick="addToCart('${externalId}', '${item.name}', ${item.price})">–î–æ–±–∞–≤–∏—Ç—å</button>
        `;
        itemsContainer.appendChild(itemCard);
      });
    }

    // –§—É–Ω–∫—Ü–∏—è addToCart —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç externalId —Ç–æ–≤–∞—Ä–∞
    function addToCart(itemExternalId, itemName, itemPrice) {
      let cartItem = cart.find((i) => i.externalId === itemExternalId);
      if (cartItem) {
        cartItem.quantity++;
      } else {
        cart.push({ externalId: itemExternalId, name: itemName, price: itemPrice, quantity: 1 });
      }
      updateCartButton();
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ—Ä–∑–∏–Ω—É —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
      saveCart();
    }

    function updateCartButton() {
      const cartBtn = document.getElementById("cart-button");
      if (cartBtn) {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartBtn.innerText = `üõí –ö–æ—Ä–∑–∏–Ω–∞ (${totalItems})`;
      }
    }

    function showCart() {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("cart-content").style.display = "block";
      renderCartItems();
    }

    function renderCartItems() {
      const cartItemsContainer = document.getElementById("cart-items");
      if (cartItemsContainer) {
        cartItemsContainer.innerHTML = "";
        if (cart.length === 0) {
          cartItemsContainer.innerHTML = "<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>";
        } else {
          let total = 0;
          cart.forEach((item) => {
            total += item.price * item.quantity;
            const cartItem = document.createElement("div");
            cartItem.className = "cart-item";
            cartItem.innerHTML = `
              <p>${item.name} - ${item.price}‚ÇΩ x ${item.quantity}</p>
              <button onclick="removeFromCart('${item.externalId}')">‚ùå</button>
            `;
            cartItemsContainer.appendChild(cartItem);
          });
          // –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
          const totalDiv = document.createElement("div");
          totalDiv.className = "cart-total";
          totalDiv.innerHTML = `<p>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: <strong>${total}‚ÇΩ</strong></p>`;
          cartItemsContainer.appendChild(totalDiv);
        }
      }
    }

    function removeFromCart(itemExternalId) {
      cart = cart.filter((i) => i.externalId !== itemExternalId);
      updateCartButton();
      saveCart();
      renderCartItems();
    }

    function showOrderForm() {
      document.getElementById("cart-content").style.display = "none";
      document.getElementById("order-form").style.display = "block";
      loadOrderFormData();
    }

    // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑" —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –≤ –±–æ—Ç–∞,
    // –∞ –∑–∞—Ç–µ–º –æ—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    function submitOrder() {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏ –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      saveOrderFormData();
      saveCart();

      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;
      const street = document.getElementById("street").value;
      const house = document.getElementById("house").value;
      const entrance = document.getElementById("entrance").value;
      const floor = document.getElementById("floor").value;
      const apartment = document.getElementById("apartment").value;
      const intercom = document.getElementById("intercom").value;

      // –ù–æ–≤—ã–µ –ø–æ–ª—è
      const deliveryType = document.getElementById("delivery_type").value;
      const orderDescription = document.getElementById("order_description").value;
      const numPersons = document.getElementById("num_persons").value;
      const deliveryTime = document.getElementById("delivery_time").value;
      const paymentType = document.getElementById("payment_type").value;

      if (!name || !phone || !street || !house || !entrance || !floor || !apartment || !intercom ||
          !deliveryType || !numPersons || !deliveryTime || !paymentType) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!");
        return;
      }

      const order = {
        user_id: tg.initDataUnsafe.user?.id || "unknown",
        // –ü–µ—Ä–µ–¥–∞—ë–º —Ç–æ–≤–∞—Ä—ã —Å externalId
        items: cart.map((item) => ({ externalId: item.externalId, price: item.price, quantity: item.quantity })),
        delivery_info: {
          name,
          phone,
          street,
          house,
          entrance,
          floor,
          apartment,
          intercom,
          deliveryType,       // –î–æ—Å—Ç–∞–≤–∫–∞ –∏–ª–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑
          orderDescription,   // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
          numPersons,         // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫
          deliveryTime,       // –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏
          paymentType         // –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
        }
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –±–æ—Ç—É
      tg.sendData(JSON.stringify(order));
      
      // –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      localStorage.removeItem("cartData");
      localStorage.removeItem("orderFormData");
      
      tg.close();
    }

    function backToCart() {
      document.getElementById("order-form").style.display = "none";
      document.getElementById("cart-content").style.display = "block";
    }

    function showItemDetails(categoryId, itemName) {
      alert(`–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞: ${itemName}`);
    }

    document.addEventListener("DOMContentLoaded", function () {
      console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...");
      fetchMenu();
      loadCart();
      loadOrderFormData();
    });
  </script>
</head>
<body>
  <div class="container">
    <div id="main-content">
      <h1>üçî –ú–∞–≥–∞–∑–∏–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã</h1>
      <div class="categories"></div>
      <div id="items" class="items"></div>
      <button id="cart-button" class="cart-button" onclick="showCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞ (0)</button>
    </div>

    <div id="cart-content" style="display: none;">
      <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <div id="cart-items"></div>
      <button class="order-button" onclick="showOrderForm()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
      <button onclick="document.getElementById('main-content').style.display='block'; document.getElementById('cart-content').style.display='none'">
        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é
      </button>
    </div>

    <div id="order-form" style="display: none;">
      <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
      <form onsubmit="event.preventDefault(); submitOrder();">
        <label for="name">–ò–º—è:</label>
        <input type="text" id="name" required />

        <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
        <input type="tel" id="phone" required />

        <label for="street">–£–ª–∏—Ü–∞:</label>
        <input type="text" id="street" required />

        <label for="house">–ù–æ–º–µ—Ä –¥–æ–º–∞:</label>
        <input type="text" id="house" required />

        <label for="entrance">–ü–æ–¥—ä–µ–∑–¥:</label>
        <input type="text" id="entrance" required />

        <label for="floor">–≠—Ç–∞–∂:</label>
        <input type="text" id="floor" required />

        <label for="apartment">–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã:</label>
        <input type="text" id="apartment" required />

        <label for="intercom">–ö–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞:</label>
        <input type="text" id="intercom" required />

        <!-- –ù–æ–≤—ã–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞ -->
        <label for="delivery_type">–¢–∏–ø –∑–∞–∫–∞–∑–∞:</label>
        <select id="delivery_type" required>
          <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
          <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
        </select>

        <label for="order_description">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:</label>
        <textarea id="order_description" rows="3"></textarea>

        <label for="num_persons">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫:</label>
        <input type="number" id="num_persons" min="1" required />

        <label for="delivery_time">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
        <input type="time" id="delivery_time" required />

        <label for="payment_type">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
        <select id="payment_type" required>
          <option value="card">–ö–∞—Ä—Ç–æ–π</option>
          <option value="cash">–ù–∞–ª–∏—á–Ω—ã–º–∏</option>
        </select>

        <button type="submit" class="confirm-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button type="button" onclick="backToCart()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ—Ä–∑–∏–Ω–µ</button>
      </form>
    </div>
  </div>
</body>
</html>


