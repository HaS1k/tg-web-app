<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞–≥–∞–∑–∏–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <script>
        let cart = [];
        let categories = {};
        let tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º Mini App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        async function fetchMenu() {
            try {
                let response = await fetch('http://127.0.0.1:8000/menu');
                let data = await response.json();

                console.log('–î–∞–Ω–Ω—ã–µ –º–µ–Ω—é:', data);

                if (typeof data === 'object' && !Array.isArray(data)) {
                    processMenuData(data);
                } else {
                    console.error('–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏', data);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
            }
        }

        function processMenuData(data) {
            categories = {};

            for (let categoryId in data) {
                let category = data[categoryId];
                categories[categoryId] = {
                    name: category.name,
                    items: category.items || []
                };
            }

            renderCategories();
        }

        function renderCategories() {
            let categoriesContainer = document.querySelector(".categories");
            if (!categoriesContainer) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç .categories –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
                return;
            }
            categoriesContainer.innerHTML = "";

            for (let categoryId in categories) {
                let category = categories[categoryId];
                let categoryButton = document.createElement("button");
                categoryButton.innerText = category.name;
                categoryButton.onclick = () => showItems(categoryId);
                categoriesContainer.appendChild(categoryButton);
            }
        }

        function showItems(categoryId) {
            let itemsContainer = document.getElementById("items");
            if (!itemsContainer) {
                console.error("–≠–ª–µ–º–µ–Ω—Ç #items –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM");
                return;
            }
            itemsContainer.innerHTML = "";

            let category = categories[categoryId];
            if (!category || !category.items) {
                console.error('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            category.items.forEach(item => {
                let itemCard = document.createElement("div");
                itemCard.className = "item-card";

                itemCard.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" onclick="showItemDetails('${categoryId}', '${item.name}')">
                    <h3>${item.name}</h3>
                    <p>${item.price}‚ÇΩ</p>
                    <button class="add-to-cart" onclick="addToCart('${categoryId}', '${item.name}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                `;
                itemsContainer.appendChild(itemCard);
            });
        }

        function showItemDetails(categoryId, itemName) {
            let category = categories[categoryId];
            if (!category) {
                console.error('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }

            let item = category.items.find(i => i.name === itemName);
            if (!item) {
                console.error('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            let modal = document.getElementById("item-modal");
            let modalContent = document.getElementById("modal-content");
            if (!modal || !modalContent) {
                console.error("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                return;
            }
            modalContent.innerHTML = `
                <h2>${item.name}</h2>
                <img src="${item.image}" alt="${item.name}">
                <p>${item.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                <p><strong>–¶–µ–Ω–∞: ${item.price}‚ÇΩ</strong></p>
                <button class="add-to-cart" onclick="addToCart('${categoryId}', '${item.name}'); closeModal()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            `;
            modal.style.display = "block";
        }

        function closeModal() {
            let modal = document.getElementById("item-modal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        function addToCart(categoryId, itemName) {
            let category = categories[categoryId];
            if (!category) {
                console.error('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }

            let item = category.items.find(i => i.name === itemName);
            if (!item) {
                console.error('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            let cartItem = cart.find(i => i.name === itemName);
            if (cartItem) {
                cartItem.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            updateCartButton();
        }

        function updateCartButton() {
            let cartBtn = document.getElementById("cart-button");
            if (cartBtn) {
                let totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                cartBtn.innerText = `üõí –ö–æ—Ä–∑–∏–Ω–∞ (${totalItems})`;
            }
        }

        function showCart() {
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
            let mainContent = document.getElementById("main-content");
            if (mainContent) {
                mainContent.style.display = "none";
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            let cartContent = document.getElementById("cart-content");
            if (cartContent) {
                cartContent.style.display = "block";
            }

            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
            let cartItemsContainer = document.getElementById("cart-items");
            if (cartItemsContainer) {
                cartItemsContainer.innerHTML = "";
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = "<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>";
                } else {
                    cart.forEach(item => {
                        let cartItem = document.createElement("div");
                        cartItem.className = "cart-item";
                        cartItem.innerHTML = `
                            <p>${item.name} - ${item.price}‚ÇΩ x ${item.quantity}</p>
                            <button onclick="removeFromCart('${item.name}')">‚ùå</button>
                        `;
                        cartItemsContainer.appendChild(cartItem);
                    });
                }
            }
        }

        function showOrderForm() {
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            let cartContent = document.getElementById("cart-content");
            if (cartContent) {
                cartContent.style.display = "none";
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
            let orderForm = document.getElementById("order-form");
            if (orderForm) {
                orderForm.style.display = "block";
            }
        }

        function submitOrder() {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            let name = document.getElementById("name").value;
            let phone = document.getElementById("phone").value;
            let street = document.getElementById("street").value;
            let house = document.getElementById("house").value;
            let entrance = document.getElementById("entrance").value;
            let floor = document.getElementById("floor").value;
            let apartment = document.getElementById("apartment").value;
            let intercom = document.getElementById("intercom").value;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
            if (!name || !phone || !street || !house || !entrance || !floor || !apartment || !intercom) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞
            const order = {
                user_id: tg.initDataUnsafe.user?.id || "unknown",
                items: cart,
                delivery_info: {
                    name,
                    phone,
                    street,
                    house,
                    entrance,
                    floor,
                    apartment,
                    intercom
                }
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
            tg.sendData(JSON.stringify(order));
            tg.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        }

        function removeFromCart(itemName) {
            cart = cart.filter(i => i.name !== itemName);
            updateCartButton();
            showCart(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...");
            fetchMenu();
        });
    </script>
</head>
<body>
    <div class="container">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="main-content">
            <h1>üçî –ú–∞–≥–∞–∑–∏–Ω –¥–æ—Å—Ç–∞–≤–∫–∏ –µ–¥—ã</h1>
            <div class="categories"></div>
            <div id="items" class="items"></div>
            <button id="cart-button" class="cart-button" onclick="showCart()">üõí –ö–æ—Ä–∑–∏–Ω–∞ (0)</button>
        </div>

        <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
        <div id="cart-content" style="display: none;">
            <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cart-items"></div>
            <button class="order-button" onclick="showOrderForm()">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <button onclick="document.getElementById('main-content').style.display='block'; document.getElementById('cart-content').style.display='none'">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é</button>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
        <div id="order-form" style="display: none;">
            <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
            <form onsubmit="event.preventDefault(); submitOrder();">
                <label for="name">–ò–º—è:</label>
                <input type="text" id="name" required>

                <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                <input type="tel" id="phone" required>

                <label for="street">–£–ª–∏—Ü–∞:</label>
                <input type="text" id="street" required>

                <label for="house">–ù–æ–º–µ—Ä –¥–æ–º–∞:</label>
                <input type="text" id="house" required>

                <label for="entrance">–ü–æ–¥—ä–µ–∑–¥:</label>
                <input type="text" id="entrance" required>

                <label for="floor">–≠—Ç–∞–∂:</label>
                <input type="text" id="floor" required>

                <label for="apartment">–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã:</label>
                <input type="text" id="apartment" required>

                <label for="intercom">–ö–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞:</label>
                <input type="text" id="intercom" required>

                <button type="submit" class="confirm-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
                <button type="button" onclick="document.getElementById('cart-content').style.display='block'; document.getElementById('order-form').style.display='none'">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ—Ä–∑–∏–Ω–µ</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞ -->
    <div id="item-modal" class="modal">
        <div class="modal-content" id="modal-content"></div>
        <button onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</body>
</html>